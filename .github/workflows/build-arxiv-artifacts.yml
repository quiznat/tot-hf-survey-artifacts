name: Build arXiv Artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc graphviz

      - name: Install LaTeX toolchain
        run: |
          sudo apt-get install -y latexmk texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended texlive-xetex lmodern

      - name: Guard against pseudo-code listings
        run: |
          bash submission/check_no_pseudo_listings.sh

      - name: Generate arXiv LaTeX source
        run: |
          bash submission/convert_to_arxiv.sh

      - name: Generate LLM-friendly Markdown
        run: |
          bash submission/build_llm_markdown.sh

      - name: Prepare arXiv workspace
        run: |
          mkdir -p submission/arxiv
          rm -rf submission/arxiv/assets
          cp -r assets submission/arxiv/assets
          cp tot-hf-agents-llm.md submission/arxiv/tot-hf-agents-llm.md
          cp LICENSE submission/arxiv/

      - name: Compile PDF from main.tex
        working-directory: submission/arxiv
        run: |
          latexmk -xelatex -interaction=nonstopmode -halt-on-error main.tex

      - name: Publish root PDF
        run: |
          cp submission/arxiv/main.pdf paper.pdf

      - name: Commit root PDF if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update generated paper.pdf [skip ci]"
          file_pattern: paper.pdf

      - name: Package arXiv bundle
        run: |
          TMP_TGZ="$(mktemp)"
          tar -czf "$TMP_TGZ" -C submission/arxiv main.tex main.pdf assets tot-hf-agents-llm.md LICENSE
          mv "$TMP_TGZ" submission/arxiv/arxiv-bundle.tgz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arxiv-artifacts
          path: |
            submission/arxiv/main.tex
            submission/arxiv/main.pdf
            tot-hf-agents-llm.md
            submission/arxiv/arxiv-bundle.tgz
