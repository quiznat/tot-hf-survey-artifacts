name: Build arXiv Artifacts

on:
  push:
    branches: [main]
    paths:
      - 'paper.html'
      - 'submission/build_llm_markdown.sh'
      - 'submission/convert_to_arxiv.sh'
      - 'submission/ARXIV_CONVERSION_NOTES.md'
      - '.github/workflows/build-arxiv-artifacts.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Install LaTeX toolchain
        run: |
          sudo apt-get install -y latexmk texlive-latex-recommended texlive-latex-extra texlive-fonts-recommended lmodern

      - name: Generate arXiv LaTeX source
        run: |
          bash submission/convert_to_arxiv.sh

      - name: Compile PDF from main.tex
        working-directory: submission/arxiv
        run: |
          latexmk -pdf -interaction=nonstopmode -halt-on-error main.tex

      - name: Generate LLM-friendly Markdown
        run: |
          bash submission/build_llm_markdown.sh

      - name: Package arXiv bundle
        run: |
          mkdir -p submission/arxiv
          rm -rf submission/arxiv/assets
          cp -r assets submission/arxiv/assets
          cp tot-hf-agents-llm.md submission/arxiv/tot-hf-agents-llm.md
          cp LICENSE submission/arxiv/
          TMP_TGZ="$(mktemp)"
          tar --exclude='arxiv-bundle.tgz' -czf "$TMP_TGZ" -C submission/arxiv .
          mv "$TMP_TGZ" submission/arxiv/arxiv-bundle.tgz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arxiv-artifacts
          path: |
            submission/arxiv/main.tex
            submission/arxiv/main.pdf
            tot-hf-agents-llm.md
            submission/arxiv/arxiv-bundle.tgz
